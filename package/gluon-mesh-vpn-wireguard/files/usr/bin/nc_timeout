#!/bin/sh
timeout=$1
host=$2
port=$3
message="$4"

( echo "$message"; sleep $timeout) | (gluon-wan nc $host $port | tail -n1) &
pid=$!
count=0
while [[ $count -lt $timeout ]]
do
  if [[ -d /proc/$pid ]]
  then
    sleep 1
    count=$((count+1))
  else
    exit
  fi
done
[[ -d /proc/$pid ]] && echo timeout reached, killing $pid && kill $pid >&2
